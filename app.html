<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>803 聊天室</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --line-green: #00B900; --bg-gray: #9bb6e6; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #ececec; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* === 頂部標題列 === */
        header { background: #222e3a; color: white; padding: 15px; text-align: center; font-size: 18px; font-weight: bold; position: fixed; top: 0; width: 100%; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        
        /* === 內容顯示區 === */
        #content { flex: 1; margin-top: 55px; margin-bottom: 60px; overflow-y: auto; padding: 10px; background-color: var(--bg-gray); scroll-behavior: smooth; }
        
        .page { display: none; height: 100%; }
        .page.active { display: block; }

        /* === 1. 聊天室樣式 === */
        .chat-container { padding-bottom: 10px; display: flex; flex-direction: column; }
        .message-row { display: flex; margin-bottom: 15px; align-items: flex-start; }
        .message-row.me { justify-content: flex-end; }
        
        .avatar { width: 40px; height: 40px; background: #fff; border-radius: 50%; text-align: center; line-height: 40px; font-size: 14px; margin-right: 8px; flex-shrink: 0; font-weight: bold; color: #555; border: 1px solid #ccc; }
        .message-row.me .avatar { display: none; }
        
        .msg-content { max-width: 70%; display: flex; flex-direction: column; }
        .sender-name { font-size: 12px; color: #444; margin-bottom: 4px; margin-left: 2px; }
        
        .bubble { background: white; padding: 10px 14px; border-radius: 15px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .message-row.me .bubble { background: #85ff49; } /* 綠色泡泡 */
        
        /* 輸入框區域 */
        .chat-input-area { position: fixed; bottom: 60px; width: 100%; background: white; padding: 10px; box-sizing: border-box; display: flex; align-items: center; border-top: 1px solid #ddd; z-index: 99; }
        .chat-input-area input { flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; margin: 0 10px; outline: none; background: #f5f5f5; }
        .chat-input-area button { background: var(--line-green); color: white; border: none; padding: 8px 18px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .icon-btn { color: #666; font-size: 20px; cursor: pointer; padding: 5px; }

        /* === 2. 相簿樣式 === */
        .gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }
        .gallery-item { aspect-ratio: 1; background: #ddd; position: relative; overflow: hidden; }
        .gallery-item img, .gallery-item video { width: 100%; height: 100%; object-fit: cover; }
        
        /* 懸浮按鈕 (FAB) */
        .fab { position: fixed; bottom: 80px; right: 20px; background: var(--line-green); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 101; }

        /* === 3. 記事本樣式 === */
        .note-card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 8px; border-left: 6px solid #ff9800; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .note-meta { display: flex; justify-content: space-between; font-size: 12px; color: #999; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }

        /* === 4. 投票樣式 === */
        .poll-card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .poll-option { margin: 12px 0; background: #f9f9f9; border: 1px solid #eee; padding: 12px; border-radius: 5px; cursor: pointer; position: relative; overflow: hidden; }
        .poll-bar { position: absolute; left: 0; top: 0; height: 100%; background: rgba(0, 185, 0, 0.15); width: 0%; transition: width 0.5s; }
        .poll-text { position: relative; z-index: 1; display: flex; justify-content: space-between; font-weight: bold; color: #333; }

        /* === 底部導航列 === */
        nav { position: fixed; bottom: 0; width: 100%; background: #fdfdfd; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; padding: 8px 0; z-index: 100; height: 60px; box-sizing: border-box; }
        .nav-item { text-align: center; color: #999; font-size: 11px; flex: 1; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-item.active { color: #333; font-weight: bold; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        
        /* 讀取中提示 */
        #loading-indicator { text-align: center; font-size: 12px; color: #666; padding: 10px; display: none; }
    </style>
</head>
<body>

    <header id="header-title">803 聊天室</header>

    <div id="content">
        <div id="page-chat" class="page active">
            <div id="chat-history" class="chat-container">
                <div id="loading-indicator">正在連線到聊天室...</div>
            </div>
        </div>

        <div id="page-album" class="page">
            <div class="gallery" id="album-grid">
                <div class="gallery-item"><img src="https://via.placeholder.com/200/92c952/fff?text=Photo1"></div>
                <div class="gallery-item"><img src="https://via.placeholder.com/200/771796/fff?text=Photo2"></div>
                <div class="gallery-item"><img src="https://via.placeholder.com/200/e0e0e0/333?text=Video"></div>
            </div>
            <div class="fab" onclick="document.getElementById('fileInput').click()">+</div>
            <input type="file" id="fileInput" hidden accept="image/*,video/*" onchange="previewUpload(this)">
        </div>

        <div id="page-notes" class="page">
            <div class="note-card">
                <div class="note-meta"><span>2026/01/20</span><span>dev</span></div>
                <h3 style="margin:0 0 10px 0;">測試</h3>
                <p style="margin:0; color:#555;">還在測試</p>
            </div>
            <div class="fab" onclick="addNoteDemo()">+</div>
        </div>

        <div id="page-vote" class="page">
            <div class="poll-card">
                <h3 style="margin-top:0;">測試</h3>
                <div class="poll-option" onclick="voteDemo(this, 60)">
                    <div class="poll-bar" style="width: 60%"></div>
                    <div class="poll-text"><span>好</span> <span>12 票</span></div>
                </div>
                <div class="poll-option" onclick="voteDemo(this, 40)">
                    <div class="poll-bar" style="width: 40%"></div>
                    <div class="poll-text"><span>好</span> <span>8 票</span></div>
                </div>
            </div>
            <div class="fab" onclick="alert('投票新增功能需資料庫完整支援')">+</div>
        </div>
    </div>

    <div class="chat-input-area" id="chat-input-bar">
        <i class="fas fa-plus icon-btn" onclick="alert('相片傳送需連接 Storage 空間，目前僅支援文字')"></i>
        <input type="text" id="msgInput" placeholder="輸入訊息..." autocomplete="off">
        <button onclick="sendMessage()">傳送</button>
    </div>

    <nav>
        <div class="nav-item active" onclick="switchPage('chat')">
            <i class="fas fa-comment"></i>聊天
        </div>
        <div class="nav-item" onclick="switchPage('album')">
            <i class="fas fa-images"></i>相簿
        </div>
        <div class="nav-item" onclick="switchPage('notes')">
            <i class="fas fa-clipboard"></i>記事本
        </div>
        <div class="nav-item" onclick="switchPage('vote')">
            <i class="fas fa-poll"></i>投票
        </div>
    </nav>

    <script>
        // ==========================================
        // ▼ 請將下方網址換成你部署後的 Google Apps Script 網址 ▼
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbwlvdmJqVryOq0b76sgWkcYlJn41uo_ByQ63XI6F0noc_iotI2XgSiPmo4tIRQSqbQ4ew/exec"; 

        // 檢查是否登入
        const currentUser = localStorage.getItem('chatUser');
        const currentId = localStorage.getItem('chatID');
        
        if (!currentUser) {
            alert("請先登入！");
            window.location.href = 'index.html';
        }

        // 頁面載入時執行
        window.onload = function() {
            if (API_URL.includes("1")) {
                alert("警告：尚未設定 API 網址，聊天功能將無法運作！請修改 app.html 第 215 行。");
            }
            loadMessages(); // 載入訊息
            // 每 2 秒自動更新一次訊息
            setInterval(loadMessages, 2000);
        };

        // --- 核心功能 1: 發送訊息 ---
        function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            // 1. 立即清空輸入框 (提升體驗)
            input.value = '';
            input.focus();

            // 2. 準備傳送的資料
            const payload = {
                user: currentId,
                name: currentUser,
                msg: text
            };

            // 3. 傳送到 Google 試算表
            fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                console.log("發送成功", data);
                loadMessages(); // 強制更新畫面
            })
            .catch(err => {
                console.error("發送失敗", err);
                alert("發送失敗，請檢查網路連線");
            });
        }

        // 支援按 Enter 發送
        document.getElementById("msgInput").addEventListener("keypress", function(e) {
            if(e.key === "Enter") sendMessage();
        });

        // --- 核心功能 2: 讀取訊息 ---
        let lastMsgCount = 0; // 用來記錄上次的訊息數量
        
        function loadMessages() {
            const indicator = document.getElementById('loading-indicator');
            
            fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                indicator.style.display = 'none';

                // 只有當訊息數量變多時，才重新渲染畫面 (避免閃爍)
                if (data.length > lastMsgCount) {
                    renderChat(data);
                    lastMsgCount = data.length;
                    // 捲動到底部
                    const content = document.getElementById('content');
                    content.scrollTop = content.scrollHeight;
                }
            })
            .catch(err => {
                console.error("讀取失敗", err);
            });
        }

        function renderChat(data) {
            const history = document.getElementById('chat-history');
            history.innerHTML = ''; // 清空舊訊息
            
            data.forEach(msg => {
                const isMe = (msg.user === currentId);
                const row = document.createElement('div');
                row.className = `message-row ${isMe ? 'me' : 'other'}`;
                
                let html = '';
                if (!isMe) {
                    // 對方的頭像與名字
                    html += `<div class="avatar" title="${msg.user}">${msg.name.substring(0,1)}</div>`;
                    html += `<div class="msg-content"><span class="sender-name">${msg.name}</span>`;
                } else {
                    html += `<div class="msg-content">`;
                }

                html += `<div class="bubble">${escapeHtml(msg.msg)}</div></div>`;
                row.innerHTML = html;
                history.appendChild(row);
            });
        }

        // 防止 XSS 攻擊的簡單處理
        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        // --- UI 邏輯: 頁面切換 ---
        function switchPage(pageId) {
            // 隱藏所有頁面
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // 顯示目標頁面
            document.getElementById('page-' + pageId).classList.add('active');
            
            // 底部導航亮起
            const navIndex = ['chat', 'album', 'notes', 'vote'].indexOf(pageId);
            document.querySelectorAll('.nav-item')[navIndex].classList.add('active');

            // 標題與輸入框控制
            document.getElementById('chat-input-bar').style.display = (pageId === 'chat') ? 'flex' : 'none';
            const titles = {'chat': '803 聊天室', 'album': '班級相簿', 'notes': '記事本', 'vote': '投票活動'};
            document.getElementById('header-title').innerText = titles[pageId];
            
            // 如果切回聊天室，自動捲到底部
            if (pageId === 'chat') {
                const content = document.getElementById('content');
                setTimeout(() => content.scrollTop = content.scrollHeight, 100);
            }
        }

        // --- 演示功能 (相簿/投票/記事本) ---
        function previewUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const grid = document.getElementById('album-grid');
                    const div = document.createElement('div');
                    div.className = 'gallery-item';
                    div.innerHTML = `<img src="${e.target.result}">`;
                    grid.prepend(div); // 加在最前面
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addNoteDemo() {
            const text = prompt("請輸入公告內容：");
            if(text) {
                const notesPage = document.getElementById('page-notes');
                const card = document.createElement('div');
                card.className = 'note-card';
                const dateStr = new Date().toLocaleDateString();
                card.innerHTML = `<div class="note-meta"><span>${dateStr}</span><span>${currentUser}</span></div><p style="margin:0;color:#333;">${text}</p>`;
                // 插入在第一個卡片後面
                notesPage.insertBefore(card, notesPage.children[1] || null);
            }
        }

        function voteDemo(element, percent) {
            // 這裡只是前端效果演示
            const bar = element.querySelector('.poll-bar');
            let currentWidth = parseInt(bar.style.width) || 0;
            // 簡單模擬票數增加
            bar.style.width = (currentWidth + 2) + '%';
            alert("投票成功！(此為演示，重整後會重置)");
        }
    </script>
</body>
</html>
